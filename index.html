<!DOCTYPE html>
<html>
 <head>
  <meta charset="UTF-8">
  <title>Basic BackgroundSync Example</title>
 </head>
 <body>
   <div id="connectionStatus">You are currently offline. Any requests made will be queued and synced as soon as you are connected again.</div>
   <p>Click on the button below to make an HTTP request.<p>
<!--   <button id="requestButton">Make an HTTP request - do it!</button>-->
<input type="text" id="name" placeholder="Name"><br/>
<input type="email" id="email" placeholder="Email"><br/>
<button id="addButton">Add Data</button>
	<script>
  /*for (var i in {1:1,2:3,3:4,4:6,5:7,6:8}){
    var d="idarticle_people";
    console.log(d);

  var DBDeleteRequest = window.indexedDB.deleteDatabase(d);
      DBDeleteRequest.onerror = function(event) {
        console.log("Erreur lors de la suppression de la base");
      };
      DBDeleteRequest.onsuccess = function(event) {
        console.log("Suppression de la base rÃ©ussie");
        console.log(event.result); // undefined
      };
   }*/

  // Connection Status
  function isOnline() {
    var connectionStatus = document.getElementById('connectionStatus');

    if (navigator.onLine){
      connectionStatus.innerHTML = 'You are currently online!';
    }
    else{
      connectionStatus.innerHTML = 'You are currently offline. Any requests made will be queued and synced as soon as you are connected again.';
    }
  }

  window.addEventListener('online', isOnline);
  window.addEventListener('offline', isOnline);
  isOnline();
  var db;

  function indexedDBOk() {
      return "indexedDB" in window;
  }
  document.addEventListener("DOMContentLoaded", function() {

      //No support? Go in the corner and pout.

      if(!indexedDBOk) return;

      var openRequest = indexedDB.open("l6",1);

      openRequest.onupgradeneeded = function(e) {
          var thisDB = e.target.result;


          if(!thisDB.objectStoreNames.contains("students")) {
              thisDB.createObjectStore("students");
          }
      }


      openRequest.onsuccess = function(e) {
          console.log("running onsuccess");
          db = e.target.result;
          if ('serviceWorker' in navigator) {
            console.log("serviceWorker in navigator");
                navigator.serviceWorker.register('/service-worker.js').then((registration) => {
                  console.log("succes enregistrement");
                return navigator.serviceWorker.ready;
              }).then((registration) => {
          //Listen for add clicks
          document.querySelector("#addButton").addEventListener("click",function(){
            addPerson();
            registration.sync.register('outbox').then(() => {
              console.log('sync registered');
            }).catch(function(error){
              console.log('Unable to fetch image.');
            });
          },false)

        }).catch(function(error){
          console.log('Unable to register Service Worker.');
        });
    }
    else{
      console.log('Service Worker functionality not supported.');
    }
      }

      openRequest.onerror = function(e) {
          //Do something for the error
      }

  },false);



    function addPerson(e) {
      // register sync

        var name = document.querySelector("#name").value;
        var email = document.querySelector("#email").value;

        console.log("About to add "+name+"/"+email);

        var transaction = db.transaction(["students"],"readwrite");
        var store = transaction.objectStore("students");

        //Define a person
        var person = {
            name:name,
            email:email,
            //created:new Date()
        }

        //Perform the add
        var request = store.add(person,1);

        request.onerror = function(e) {
            console.log("Error",e.target.error.name);
            //some type of error handler
        }

        request.onsuccess = function(e) {
            console.log("Woot! Did it");
        }


    }



	</script>
  </body>
</html>
